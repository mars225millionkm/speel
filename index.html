<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sleep¬∑track ¬∑ auto % ¬∑ 8h goal</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
        }
        body {
            background: #f1f5f9;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
        }
        .card {
            max-width: 1000px;
            width: 100%;
            background: white;
            border-radius: 2rem;
            box-shadow: 0 20px 35px -8px rgba(0,0,0,0.15);
            padding: 2rem 2rem 2.5rem;
        }
        h1 {
            font-size: 2rem;
            font-weight: 500;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #0a1120;
            margin-bottom: 0.25rem;
        }
        h1 span {
            background: #e6f0ff;
            font-size: 0.9rem;
            font-weight: 400;
            padding: 0.2rem 1rem;
            border-radius: 40px;
            color: #1e4a7a;
        }
        .sub {
            color: #2c3e5c;
            margin-bottom: 1.8rem;
            font-size: 1rem;
            border-left: 4px solid #90b4f0;
            padding-left: 1rem;
        }
        .entry-panel {
            background: #f8fafd;
            border-radius: 1.5rem;
            padding: 1.6rem 2rem;
            margin-bottom: 2.2rem;
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 1.8rem;
            border: 1px solid #dde7f0;
        }
        .field-group {
            display: flex;
            flex-direction: column;
            min-width: 180px;
        }
        .field-group label {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            font-weight: 600;
            color: #2c4b74;
            margin-bottom: 0.3rem;
        }
        .field-group input {
            background: white;
            border: 1px solid #bdcde0;
            border-radius: 60px;
            padding: 0.75rem 1.2rem;
            font-size: 1rem;
            width: 100%;
            outline: none;
            transition: 0.15s;
        }
        .field-group input:focus {
            border-color: #3e74c0;
            box-shadow: 0 0 0 3px rgba(62,116,192,0.15);
        }
        .field-group input[readonly] {
            background-color: #ecf2f9;
            color: #0f2e4a;
            font-weight: 500;
            border-color: #b3c9e5;
            cursor: default;
        }
        .inline-hint {
            font-size: 0.9rem;
            color: #4b5e7a;
            margin-top: 0.3rem;
        }
        .btn {
            background: #1f3a6b;
            color: white;
            border: none;
            font-weight: 500;
            padding: 0.8rem 2rem;
            border-radius: 60px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.15s;
            border: 1px solid #1f3a6b;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .btn-outline {
            background: white;
            color: #1f3a6b;
            border: 1px solid #a7c0e2;
        }
        .btn-outline:hover {
            background: #ecf3fc;
            border-color: #1f3a6b;
        }
        .btn:hover {
            background: #102a50;
            border-color: #102a50;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
            margin-bottom: 2.5rem;
        }
        .stat-box {
            background: #ffffff;
            border-radius: 1.5rem;
            padding: 1.5rem 1.8rem;
            box-shadow: 0 4px 12px rgba(0,20,40,0.02);
            border: 1px solid #dde3ec;
        }
        .stat-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #546e8a;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.3rem;
        }
        .stat-value {
            font-size: 2.8rem;
            font-weight: 400;
            line-height: 1.2;
            color: #0b1b33;
        }
        .stat-value small {
            font-size: 1.2rem;
            font-weight: 300;
            color: #5f7698;
            margin-left: 0.3rem;
        }
        .stat-note {
            color: #335b8a;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin: 1.2rem 0 1rem;
        }
        .history-header h3 {
            font-weight: 500;
            color: #14273e;
            font-size: 1.3rem;
        }
        .history-list {
            background: #f9fcff;
            border-radius: 1.4rem;
            border: 1px solid #d9e4f0;
            overflow: hidden;
        }
        .history-row {
            display: grid;
            grid-template-columns: 100px 1fr 120px 120px;
            align-items: center;
            padding: 0.9rem 1.5rem;
            border-bottom: 1px solid #dce6f0;
            background: white;
        }
        .history-row:last-child {
            border-bottom: none;
        }
        .history-index {
            color: #2a4e77;
            font-weight: 450;
        }
        .history-data {
            display: flex;
            gap: 1.2rem;
            font-weight: 500;
        }
        .history-data span {
            background: #eaf1fb;
            padding: 0.25rem 0.8rem;
            border-radius: 30px;
            font-size: 0.9rem;
            color: #113355;
        }
        .history-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        .edit-btn, .delete-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            padding: 0.4rem 1rem;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 500;
            transition: 0.1s;
        }
        .edit-btn {
            background: #e2ebf6;
            color: #1b3f64;
        }
        .edit-btn:hover {
            background: #c7daf2;
        }
        .delete-btn {
            background: #fee9e7;
            color: #a03f33;
        }
        .delete-btn:hover {
            background: #fccac5;
        }
        .empty-message {
            padding: 2rem;
            text-align: center;
            color: #6d8bb0;
            font-style: italic;
        }
        .footer-note {
            margin-top: 1.2rem;
            font-size: 0.9rem;
            color: #567196;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .max-highlight {
            background: #f2eefb;
            border-radius: 50px;
            padding: 0.4rem 1.2rem;
            font-weight: 500;
            color: #1f3857;
        }
    </style>
</head>
<body>
<div class="card">
    <h1>üò¥ sleep meter <span>8h = 100%</span></h1>
    <div class="sub">enter minutes ‚Üí percentage auto‚Äëcalculated ¬∑ no dates</div>

    <!-- ENTRY FORM (ADD / UPDATE) with auto % -->
    <div class="entry-panel" id="entryPanel">
        <div class="field-group">
            <label>‚è±Ô∏è sleep minutes</label>
            <input type="number" id="minutesInput" placeholder="e.g. 420" min="0" step="1" value="480">
            <div class="inline-hint">8h = 480 min = 100%</div>
        </div>
        <div class="field-group">
            <label>üìä % (auto from minutes)</label>
            <input type="number" id="percentInput" readonly step="any" value="100">
            <div class="inline-hint">automatically updates</div>
        </div>
        <button class="btn" id="addBtn">‚ûï add entry</button>
        <button class="btn-outline btn" id="cancelEdit" style="display: none;">‚úñ cancel edit</button>
    </div>

    <!-- DASHBOARD (only requested stats) -->
    <div class="dashboard">
        <div class="stat-box">
            <div class="stat-label">month avg sleep %</div>
            <div class="stat-value" id="avgPercent">‚Äî<small>%</small></div>
            <div class="stat-note">based on your daily %</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">‚≠ê highest recorded</div>
            <div class="stat-value" id="highestPercent">‚Äî<small>%</small></div>
            <div class="stat-note" id="highestHours">‚Äî minutes</div>
        </div>
    </div>

    <!-- HISTORY (editable list) -->
    <div class="history-header">
        <h3>üìã sleep history (day by day)</h3>
        <span class="max-highlight" id="totalEntries">0 days</span>
    </div>
    <div id="historyContainer" class="history-list">
        <!-- dynamic rows -->
        <div class="empty-message">no entries yet ‚Äì add your first sleep</div>
    </div>

    <div class="footer-note">
        <span>‚úÖ edit any entry ‚Üí dashboard updates</span>
        <span>‚ö° % always matches minutes (8h base)</span>
    </div>
</div>

<script>
    (function() {
        // reference: 8 hours = 480 minutes = 100%
        const IDEAL_MINUTES = 480;

        // ----- store entries as array of objects { minutes: number, percent: number } -----
        let sleepEntries = [];

        // ----- edit state -----
        let editIndex = null;          // index of entry being edited, null = add mode

        // ----- DOM elements -----
        const minutesInput = document.getElementById('minutesInput');
        const percentInput = document.getElementById('percentInput');
        const addBtn = document.getElementById('addBtn');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const historyContainer = document.getElementById('historyContainer');
        const avgPercentSpan = document.getElementById('avgPercent');
        const highestPercentSpan = document.getElementById('highestPercent');
        const highestHoursSpan = document.getElementById('highestHours');
        const totalEntriesSpan = document.getElementById('totalEntries');

        // ----- auto-update percent field when minutes change -----
        function updatePercentFromMinutes() {
            const mins = parseFloat(minutesInput.value);
            if (!isNaN(mins) && mins >= 0) {
                // percent = (minutes / 480) * 100
                const computedPercent = (mins / IDEAL_MINUTES) * 100;
                percentInput.value = computedPercent.toFixed(2);  // keep 2 decimals for precision
            } else {
                percentInput.value = '';  // empty if invalid
            }
        }

        // listen to input events on minutes field
        minutesInput.addEventListener('input', updatePercentFromMinutes);

        // also when field loses focus, ensure it's correct (if someone typed negative, adjust)
        minutesInput.addEventListener('blur', function() {
            let mins = parseFloat(minutesInput.value);
            if (isNaN(mins) || mins < 0) {
                minutesInput.value = 0;
                updatePercentFromMinutes();
            }
        });

        // ----- helper: update dashboard & history & store -----
        function saveToLocal() {
            localStorage.setItem('sleepEntries', JSON.stringify(sleepEntries));
        }

        function loadFromLocal() {
            const stored = localStorage.getItem('sleepEntries');
            if (stored) {
                try {
                    sleepEntries = JSON.parse(stored);
                } catch (e) {
                    sleepEntries = [];
                }
            } else {
                // demo entries: 240 min ‚Üí 50%, 480 min ‚Üí 100%
                sleepEntries = [
                    { minutes: 240, percent: 50.00 },
                    { minutes: 480, percent: 100.00 },
                ];
            }
        }

        // ----- render history rows based on sleepEntries array -----
        function renderHistory() {
            if (sleepEntries.length === 0) {
                historyContainer.innerHTML = `<div class="empty-message">no entries yet ‚Äì add your first sleep</div>`;
                return;
            }

            let html = '';
            sleepEntries.forEach((entry, idx) => {
                const mins = entry.minutes;
                const perc = entry.percent;
                // round percent for display (1 decimal max, but keep clean)
                const percDisplay = Number(perc).toFixed(1).replace(/\.0$/, '');
                const minsDisplay = mins + ' min';

                html += `
                    <div class="history-row" data-index="${idx}">
                        <div class="history-index">day ${idx+1}</div>
                        <div class="history-data">
                            <span>${minsDisplay}</span>
                            <span>${percDisplay}%</span>
                        </div>
                        <div class="history-actions">
                            <button class="edit-btn" data-index="${idx}">edit</button>
                            <button class="delete-btn" data-index="${idx}">delete</button>
                        </div>
                        <div></div>
                    </div>
                `;
            });
            historyContainer.innerHTML = html;

            // attach event listeners to edit/delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.target.getAttribute('data-index');
                    if (idx !== null) startEdit(parseInt(idx));
                });
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const idx = e.target.getAttribute('data-index');
                    if (idx !== null) deleteEntry(parseInt(idx));
                });
            });
        }

        // ----- update dashboard: avg, highest, and highest minutes -----
        function updateStats() {
            const n = sleepEntries.length;
            if (n === 0) {
                avgPercentSpan.innerText = '‚Äî';
                highestPercentSpan.innerText = '‚Äî';
                highestHoursSpan.innerText = 'no entries';
                totalEntriesSpan.innerText = '0 days';
                return;
            }

            // average of percents (as described: 50 + 100 = 150, 150/2 = 75)
            let sumPerc = 0;
            let maxPerc = -Infinity;
            let maxMinutes = 0;

            sleepEntries.forEach(entry => {
                const p = entry.percent;
                sumPerc += p;
                if (p > maxPerc) {
                    maxPerc = p;
                    maxMinutes = entry.minutes;   // minutes of highest percentage entry
                }
            });

            const avg = sumPerc / n;
            // format avg with 1 decimal if needed
            avgPercentSpan.innerText = avg.toFixed(1).replace(/\.0$/, '') + '%';

            highestPercentSpan.innerText = maxPerc.toFixed(1).replace(/\.0$/, '') + '%';
            highestHoursSpan.innerText = maxMinutes + ' minutes (at highest %)';

            totalEntriesSpan.innerText = n + (n === 1 ? ' day' : ' days');
        }

        // ----- add new entry (from input fields) -----
        function addEntry() {
            const mins = parseFloat(minutesInput.value);
            // percent comes from the auto field (readonly, but we still read it)
            const perc = parseFloat(percentInput.value);

            // validation: minutes must be valid non-negative, percent must be valid number
            if (isNaN(mins) || mins < 0 || isNaN(perc) || perc < 0) {
                alert('‚ùå please enter valid minutes (>=0). percentage will auto-calculate.');
                return;
            }

            const newEntry = { minutes: mins, percent: perc };

            if (editIndex !== null) {
                // update existing entry
                sleepEntries[editIndex] = newEntry;
                editIndex = null;
                addBtn.innerText = '‚ûï add entry';
                cancelEditBtn.style.display = 'none';
            } else {
                // add new
                sleepEntries.push(newEntry);
            }

            // save, re-render, update dashboard, and reset fields
            saveToLocal();
            renderHistory();
            updateStats();

            // reset minutes to default (480) ‚Üí triggers auto percent update
            minutesInput.value = '480';
            updatePercentFromMinutes();   // explicitly set percent to 100
        }

        // ----- start editing an entry (populate form, change button) -----
        function startEdit(index) {
            if (index < 0 || index >= sleepEntries.length) return;
            const entry = sleepEntries[index];
            minutesInput.value = entry.minutes;
            // manually trigger percent update (though minutes changed, but call to be safe)
            updatePercentFromMinutes();   // percent field will be set based on minutes
            editIndex = index;
            addBtn.innerText = '‚úèÔ∏è update entry';
            cancelEditBtn.style.display = 'inline-block';
        }

        // ----- cancel editing -----
        function cancelEdit() {
            editIndex = null;
            minutesInput.value = '480';
            updatePercentFromMinutes();   // resets percent to 100
            addBtn.innerText = '‚ûï add entry';
            cancelEditBtn.style.display = 'none';
        }

        // ----- delete entry -----
        function deleteEntry(index) {
            if (index < 0 || index >= sleepEntries.length) return;
            sleepEntries.splice(index, 1);

            // if we were editing that deleted entry, cancel edit mode
            if (editIndex === index) {
                cancelEdit();
            } else if (editIndex !== null && editIndex > index) {
                // shifting indices: decrement editIndex if it's after deleted
                editIndex -= 1;
            }

            saveToLocal();
            renderHistory();
            updateStats();

            // if no entries remain and we were in edit mode, already canceled
            if (sleepEntries.length === 0 && editIndex !== null) cancelEdit();
        }

        // ----- initial load and render -----
        loadFromLocal();
        renderHistory();
        updateStats();
        // ensure percent field is correct for initial default minutes (480)
        updatePercentFromMinutes();

        // ----- event listeners -----
        addBtn.addEventListener('click', addEntry);

        cancelEditBtn.addEventListener('click', () => {
            cancelEdit();
        });

        // preserve state on window unload
        window.addEventListener('beforeunload', function() {
            saveToLocal();
        });

        // when editing, we keep auto percent; no manual percent needed
        // delete/edit already handled
    })();
</script>
</body>
</html>
